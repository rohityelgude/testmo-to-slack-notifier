name: Testmo to Slack

on:
  workflow_dispatch:

jobs:
  send_testmo_results:
    runs-on: ubuntu-latest
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Get latest Testmo automation run
        id: get_run
        run: |
          echo "Fetching latest automation run from Testmo..."
          response=$(curl -s -H "Authorization: Bearer ${{ secrets.TESTMO_API_TOKEN }}" \
            "https://${{ secrets.TESTMO_BASE_URL }}/api/v1/projects/1/automation/runs?limit=1&sort=created_at:desc")

          echo "API Response:"
          echo "$response"

          echo "$response" > latest_run.json

          latest_id=$(jq -r '.automation_runs[0].id' latest_run.json)
          status=$(jq -r '.automation_runs[0].status' latest_run.json)
          passed=$(jq -r '.automation_runs[0].passed_count' latest_run.json)
          total=$(jq -r '.automation_runs[0].total_count' latest_run.json)

          echo "latest_id=$latest_id" >> $GITHUB_OUTPUT
          echo "status=$status" >> $GITHUB_OUTPUT
          echo "passed=$passed" >> $GITHUB_OUTPUT
          echo "total=$total" >> $GITHUB_OUTPUT

      - name: Send Slack message
        run: |
          if [ -z "${{ steps.get_run.outputs.latest_id }}" ] || [ "${{ steps.get_run.outputs.latest_id }}" = "null" ]; then
            echo "No run found, skipping Slack notification."
            exit 0
          fi

          slack_message=":mega: New Testmo Automation Run #${{ steps.get_run.outputs.latest_id }}
:bar_chart: Status: ${{ steps.get_run.outputs.status }}
:white_check_mark: Passed: ${{ steps.get_run.outputs.passed }} / ${{ steps.get_run.outputs.total }}
:link: <https://${{ secrets.TESTMO_BASE_URL }}/automation/runs/${{ steps.get_run.outputs.latest_id }}|View Run>"
